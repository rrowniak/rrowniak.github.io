<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Tip of the day: gcc address sanitizer | Rafal‚Äôs blog</title>
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="Tip of the day: gcc address sanitizer" />
<meta name="author" content="Rafa≈Ç R√≥wniak" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Today I‚Äôm going to show you how effectively solve painful issues related to memory corruption occurrences." />
<meta property="og:description" content="Today I‚Äôm going to show you how effectively solve painful issues related to memory corruption occurrences." />
<link rel="canonical" href="http://localhost:4000/_site/linux/tip-of-the-day-gcc-memory-sanitizer/" />
<meta property="og:url" content="http://localhost:4000/_site/linux/tip-of-the-day-gcc-memory-sanitizer/" />
<meta property="og:site_name" content="Rafal‚Äôs blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-03T09:05:24+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Tip of the day: gcc address sanitizer" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Rafa≈Ç R√≥wniak"},"dateModified":"2021-02-03T09:05:24+01:00","datePublished":"2021-02-03T09:05:24+01:00","description":"Today I‚Äôm going to show you how effectively solve painful issues related to memory corruption occurrences.","headline":"Tip of the day: gcc address sanitizer","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/_site/linux/tip-of-the-day-gcc-memory-sanitizer/"},"url":"http://localhost:4000/_site/linux/tip-of-the-day-gcc-memory-sanitizer/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/_site/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/_site/feed.xml" title="Rafal&apos;s blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/_site/">Rafal&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/_site/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Tip of the day: gcc address sanitizer</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-02-03T09:05:24+01:00" itemprop="datePublished">Feb 3, 2021
      </time>‚Ä¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Rafa≈Ç R√≥wniak</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Today I‚Äôm going to show you how effectively solve painful issues related to memory corruption occurrences.</p>

<p>Let‚Äôs start from the example. Consider the following code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;pre class="wp-block-code"&gt;```cpp
#include &lt;iostream&gt;

int array[2];
int table[2];

int main(int argc, char** argv)
{   
    array[2] = 11;

    if (table[0] == 0) {
        std::cout &lt;&lt; "Obvious!" &lt;&lt; std::endl;
    } else {
        std::cout &lt;&lt; "Not really... Something is wrong" &lt;&lt; std::endl;
        std::cout &lt;&lt; table[0] &lt;&lt; " vs " &lt;&lt; array[2] &lt;&lt; std::endl;
    }

    return array[0];
}
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
And corresponding makefile:

</code></pre></div></div>
<pre class="wp-block-code">```bash
CPPFLAGS = -g -Wall
LDFLAGS = -g
LDLIBS = -lm -ldl

test: test.o
    g++ $(LDFLAGS) -o test test.o $(LDLIBS)

test.o: test.cpp
    g++ $(CPPFLAGS) -c test.cpp

clean:
    @rm test test.o
```
```

Let‚Äôs build &amp; execute the program:

```
<pre class="wp-block-code">```bash
$ make
 g++ -g -Wall -c test.cpp
 g++ -g -o test test.o -lm -ldl
$ ./test 
 Not really‚Ä¶ Something is wrong
 11 vs 11
```
```

The issue is visible in the source without using any fancy tool. But if you have hundreds of thousands of lines of code, the problem isn‚Äôt such trivial. Moreover, it may not manifest all the time but just from time to time and it doesn‚Äôt have to be a crash ‚Äì sometimes it‚Äôs just a weird program behavior like the above example.

Can we do anything around that? Yes ‚Äì gcc built-in address sanitizer. That feature adds additional instrumentation to our code and will perform monitoring in the runtime like checking whether our code access only allocated memory, stack overflows, and many more.

In order to enable the address sanitizer let‚Äôs modify slightly our makefile:

```
<pre class="wp-block-code">```bash
CPPFLAGS = -g -Wall
LDFLAGS = -g
LDLIBS = -lm -ldl

test: test.o
    g++ $(LDFLAGS) -o test test.o $(LDLIBS)

test.o: test.cpp
    g++ $(CPPFLAGS) -c test.cpp

asan: CPPFLAGS += -fsanitize=address
asan: LDLIBS += -lasan
asan: test

clean:
    @rm test test.o
```
```

And build ‚Äì this time using non-default target:

```
<pre class="wp-block-code">```bash
$ make clean
$ make asan
 g++ -g -Wall -fsanitize=address -c test.cpp
 g++ -g -o test test.o -lm -ldl -lasan
```
```

Now the most interesting part ‚Äì let‚Äôs execute our program:

```
<pre class="wp-block-code">```bash
$ ./test 
 ==26315==ERROR: AddressSanitizer: global-buffer-overflow on address 0x55b90bac2388 at pc 0x55b90b8c0ffb bp 0x7ffe6500cb20 sp 0x7ffe6500cb10
 WRITE of size 4 at 0x55b90bac2388 thread T0
     #0 0x55b90b8c0ffa in main /home/local/CORVIL/rrowniak/tmp/sanitizer/test.cpp:8
     #1 0x7f088b811bf6 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21bf6)
     #2 0x55b90b8c0ed9 in _start (/home/local/CORVIL/rrowniak/tmp/sanitizer/test+0xed9)
 0x55b90bac2388 is located 0 bytes to the right of global variable 'array' defined in 'test.cpp:3:5' (0x55b90bac2380) of size 8
 0x55b90bac2388 is located 56 bytes to the left of global variable 'table' defined in 'test.cpp:4:5' (0x55b90bac23c0) of size 8
 SUMMARY: AddressSanitizer: global-buffer-overflow /home/local/CORVIL/rrowniak/tmp/sanitizer/test.cpp:8 in main
 Shadow bytes around the buggy address:
   0x0ab7a1750420: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   0x0ab7a1750430: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   0x0ab7a1750440: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   0x0ab7a1750450: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   0x0ab7a1750460: 00 00 00 00 00 00 00 00 01 f9 f9 f9 f9 f9 f9 f9
 =&gt;0x0ab7a1750470: 00[f9]f9 f9 f9 f9 f9 f9 00 f9 f9 f9 f9 f9 f9 f9
   0x0ab7a1750480: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   0x0ab7a1750490: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   0x0ab7a17504a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   0x0ab7a17504b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   0x0ab7a17504c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
 Shadow byte legend (one shadow byte represents 8 application bytes):
   Addressable:           00
   Partially addressable: 01 02 03 04 05 06 07 
   Heap left redzone:       fa
   Freed heap region:       fd
   Stack left redzone:      f1
   Stack mid redzone:       f2
   Stack right redzone:     f3
   Stack after return:      f5
   Stack use after scope:   f8
   Global redzone:          f9
   Global init order:       f6
   Poisoned by user:        f7
   Container overflow:      fc
   Array cookie:            ac
   Intra object redzone:    bb
   ASan internal:           fe
   Left alloca redzone:     ca
   Right alloca redzone:    cb
 ==26315==ABORTING
```
```

At first glance the output looks a bit scary. But there is everything that you need to solve the puzzle. Especially that comment: ‚Äû*AddressSanitizer: **global-buffer-overflow on address** (‚Ä¶) **WRITE of size 4** in main /home/**test.cpp:8** (‚Ä¶)*‚Äù ‚Äì that‚Äôs all what you really need.

That‚Äôs it, see you next time üôÇ
</pre></pre></pre></pre></pre>

  </div><a class="u-url" href="/_site/linux/tip-of-the-day-gcc-memory-sanitizer/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/_site/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Rafal&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Rafal&#39;s blog</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/rrowniak"><svg class="svg-icon"><use xlink:href="/_site/assets/minima-social-icons.svg#github"></use></svg> <span class="username">rrowniak</span></a></li><li><a href="https://www.twitter.com/rrowniak"><svg class="svg-icon"><use xlink:href="/_site/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">rrowniak</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Welcome to my IT blog! Here, you will find articles on a wide range of topics related to technology and computer science.  My blog covers everything from software architecture and programming languages like C++ to performance optimization and Linux systems.  Whether you&#39;re a seasoned IT professional or just starting out in the field, I hope you&#39;ll find something of interest on my blog.  Follow me to stay up to date with the latest trends and best practices in the world of technology.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
